#!/usr/bin/env sh

if [ "$GIT_BRANCH" = "origin/develop" ]; then
  TARGET="130.211.78.173"
  SERVER_ENV=staging
  echo "building for staging environment $TARGET"
elif [ "$GIT_BRANCH" = "origin/master" ]; then
  TARGET=production
  SERVER_ENV=production
  echo "production environment does not yet exist, exiting..."
  exit 0
else
  echo "no environment exists for $GIT_BRANCH, exiting..."
  exit 0
fi

DONT_CHECK_KEYS="-oStrictHostKeyChecking=no"

# copy over upstart services and virtualhost configuration
scp "$DONT_CHECK_KEYS" -r "$WORKSPACE/etc/init/cloud_sql_proxy.conf" "root@$TARGET:/etc/init" && echo "copied cloudsql init"

scp "$DONT_CHECK_KEYS" -r "$WORKSPACE/etc/init/lifekey-server.conf" "root@$TARGET:/etc/init" && echo "copied lifekey server init"

scp "$DONT_CHECK_KEYS" -r "$WORKSPACE/etc/nginx/$SERVER_ENV/$SERVER_ENV.api.lifekey.cnsnt.io" "root@$TARGET:/etc/nginx/sites-available" && echo "copied virtualhost"

# stop the sevice and remove current source code
ssh "$DONT_CHECK_KEYS" "root@$TARGET" "stop lifekey-server; rm -rf /srv/$SERVER_ENV.api.lifekey.cnsnt.io" && echo "stopped service and removed source code"

# copy new source code
scp "$DONT_CHECK_KEYS" -r "$WORKSPACE" "root@$TARGET:/srv/$SERVER_ENV.api.lifekey.cnsnt.io" && echo "copied source code"

# restart the service once everything has been replaced
ssh "$DONT_CHECK_KEYS" "root@$TARGET" "start lifekey-server; service nginx restart" && echo "restarted service and nginx"